<!-- ===================== CASH PANEL (Buttons only) ===================== -->
<div id="cashPanel" class="mt-2 p-4 rounded-xl border border-slate-200 bg-slate-50 space-y-3">

  <!-- Total -->
  <div class="flex items-center justify-between">
    <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">
      Total
    </span>
    <span id="cashTotalLabel" class="text-sm font-bold text-slate-900">
      Rp 0
    </span>
  </div>

  <div class="border-t border-dashed border-slate-300"></div>

  <!-- Di Bayar -->
  <div class="flex items-center justify-between text-sm">
    <span class="text-slate-600 font-medium">Di bayar</span>
    <span id="sumPaid" class="font-bold text-slate-800">
      Rp 0
    </span>
  </div>

  <!-- Kembalian -->
  <div class="flex items-center justify-between text-sm">
    <span class="text-slate-600 font-medium">Kembalian</span>
    <span id="sumChange" class="font-bold text-emerald-700">
      Rp 0
    </span>
  </div>

  <div class="border-t border-slate-200"></div>

  <!-- Action Buttons -->
  <div class="grid grid-cols-2 gap-2 pt-1">
    <!-- Cash Button -->
    <button
      type="button"
      onclick="openCashModal()"
      class="h-11 rounded-xl bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 active:scale-95 transition">
      Cash
    </button>

    <!-- Placeholder / Future Button -->
    <button
      type="button"
      disabled
      class="h-11 rounded-xl bg-slate-200 text-slate-400 text-sm font-semibold cursor-not-allowed">
      Manual
    </button>
  </div>

  <!-- Hidden inputs -->
  <input type="hidden" id="cashPaidHidden" name="cashPaid" value="0">
  <input type="hidden" id="cashChangeHidden" name="cashChange" value="0">

</div>



<!-- ===================== CASH SUMMARY MODAL ===================== -->
<div id="cashModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
  <div class="bg-white w-full max-w-xs rounded-2xl p-4 shadow-2xl">

    <h3 class="text-center font-bold text-lg mb-1">Cash</h3>
    <p class="text-center text-xs text-slate-500 mb-3">
      Ringkasan pembayaran tunai
    </p>

    <div class="space-y-2 text-sm mb-3">
      <div class="flex justify-between">
        <span class="text-slate-600 font-semibold">Total</span>
        <span id="sumTotal" class="font-bold text-indigo-600">Rp 0</span>
      </div>
      <div class="flex justify-between">
        <span class="text-slate-600 font-semibold">Dibayar</span>
<span class="sumPaid font-bold text-slate-800">Rp 0</span>
      </div>
      <div class="flex justify-between pt-2 border-t border-slate-200">
        <span class="text-slate-600 font-semibold">Kembalian</span>
<span class="sumChange font-bold text-emerald-700">Rp 0</span>
      </div>
      <div id="sumNotEnough" class="hidden text-[11px] text-red-600 font-semibold pt-1">
        Uang tunai kurang dari total.
      </div>
    </div>

    <!-- أزرار سريعة داخل مودال الكاش -->
    <div class="grid grid-cols-3 gap-2 mb-3">
      <button type="button" onclick="setCashAmount(20000)"
        class="h-11 rounded-xl bg-white border border-slate-200 hover:bg-slate-100 text-sm font-semibold active:scale-95">
        20.000
      </button>
      <button type="button" onclick="setCashAmount(50000)"
        class="h-11 rounded-xl bg-white border border-slate-200 hover:bg-slate-100 text-sm font-semibold active:scale-95">
        50.000
      </button>
      <button type="button" onclick="setCashAmount(100000)"
        class="h-11 rounded-xl bg-white border border-slate-200 hover:bg-slate-100 text-sm font-semibold active:scale-95">
        100.000
      </button>
    </div>

    <div class="flex gap-2">
      <button type="button" onclick="clearCash()"
        class="w-20 h-11 rounded-xl bg-red-50 border border-red-100 text-red-600 text-sm font-semibold hover:bg-red-100 active:scale-95">
        C
      </button>

      <button type="button" onclick="openManualModal()"
        class="flex-1 h-11 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 active:scale-95">
        Manual
      </button>
    </div>

    <div class="mt-3 flex gap-2">
      <button type="button" onclick="closeCashModal()"
        class="flex-1 h-11 rounded-xl border border-slate-300 text-slate-600 text-sm font-semibold hover:bg-slate-50 active:scale-95">
        Tutup
      </button>
      <button type="button" onclick="confirmCashOnly()"
        class="flex-1 h-11 rounded-xl bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 active:scale-95">
        OK
      </button>
    </div>

  </div>
</div>


<!-- ===================== MANUAL KEYPAD MODAL (0-9) ===================== -->
<div id="manualModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
  <div class="bg-white w-full max-w-xs rounded-2xl p-4 shadow-2xl">

    <h3 class="text-center font-bold text-lg mb-1">Manual Tunai</h3>
    <p class="text-center text-xs text-slate-500 mb-3">
      Total: <span id="keyTotal" class="font-bold text-indigo-600">Rp 0</span>
    </p>

    <div id="keyDisplay"
      class="w-full text-right text-2xl font-mono font-bold border rounded-xl px-3 py-2 mb-3">
      Rp 0
    </div>

    <div class="grid grid-cols-3 gap-2 mb-3">
      <button type="button" onclick="appendKey('1')" class="h-12 rounded-xl bg-slate-50 border border-slate-200 text-lg font-bold hover:bg-slate-100 active:scale-95">1</button>
      <button type="button" onclick="appendKey('2')" class="h-12 rounded-xl bg-slate-50 border border-slate-200 text-lg font-bold hover:bg-slate-100 active:scale-95">2</button>
      <button type="button" onclick="appendKey('3')" class="h-12 rounded-xl bg-slate-50 border border-slate-200 text-lg font-bold hover:bg-slate-100 active:scale-95">3</button>
      <button type="button" onclick="appendKey('4')" class="h-12 rounded-xl bg-slate-50 border border-slate-200 text-lg font-bold hover:bg-slate-100 active:scale-95">4</button>
      <button type="button" onclick="appendKey('5')" class="h-12 rounded-xl bg-slate-50 border border-slate-200 text-lg font-bold hover:bg-slate-100 active:scale-95">5</button>
      <button type="button" onclick="appendKey('6')" class="h-12 rounded-xl bg-slate-50 border border-slate-200 text-lg font-bold hover:bg-slate-100 active:scale-95">6</button>
      <button type="button" onclick="appendKey('7')" class="h-12 rounded-xl bg-slate-50 border border-slate-200 text-lg font-bold hover:bg-slate-100 active:scale-95">7</button>
      <button type="button" onclick="appendKey('8')" class="h-12 rounded-xl bg-slate-50 border border-slate-200 text-lg font-bold hover:bg-slate-100 active:scale-95">8</button>
      <button type="button" onclick="appendKey('9')" class="h-12 rounded-xl bg-slate-50 border border-slate-200 text-lg font-bold hover:bg-slate-100 active:scale-95">9</button>

      <button type="button" onclick="clearKey()"
        class="h-12 rounded-xl bg-red-50 border border-red-100 text-red-600 font-bold hover:bg-red-100 active:scale-95">
        C
      </button>

      <button type="button" onclick="appendKey('0')"
        class="h-12 rounded-xl bg-slate-50 border border-slate-200 text-lg font-bold hover:bg-slate-100 active:scale-95">
        0
      </button>

      <button type="button" onclick="confirmKey()"
        class="h-12 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-700 active:scale-95">
        OK
      </button>
    </div>

    <button type="button" onclick="closeManualModal()"
      class="w-full py-2 text-sm text-slate-500 hover:text-slate-700">
      Batal
    </button>
  </div>
</div>


<script>
  // ===== Helpers =====
  function parseIdrToNumber(text) {
    if (!text) return 0;
    return Number(String(text).replace(/[^\d]/g, "")) || 0;
  }

  function formatIdr(n) {
    n = Number(n || 0);
    return "Rp " + n.toLocaleString("id-ID");
  }

  function getGrandTotalFromUI() {
    const el = document.getElementById("totalDisplay");
    return parseIdrToNumber(el ? el.textContent : "0");
  }

  // ===== State =====
  let paid = 0;      // uang dibayar
  let keyValue = ""; // input keypad

  // تحديث كل شيء (panel + modal)
  function updateCashUI() {
    const total = getGrandTotalFromUI();
    const change = paid - total;
// ===== Put results into your customer modal =====
const selected = document.querySelector('input[name="paymentRadio"]:checked')?.value;

// show results فقط إذا Cash
const wrap = document.getElementById("cashResultWrap");
if (wrap) wrap.classList.toggle("hidden", selected !== "cash");

if (selected === "cash") {
  const paidText = formatIdr(paid);
  const changeText = formatIdr(Math.max(0, change));

document.querySelectorAll(".sumPaid").forEach(el => el.textContent = paidText);
document.querySelectorAll(".sumChange").forEach(el => el.textContent = changeText);

  document.getElementById("modalPaidCashHidden") && (document.getElementById("modalPaidCashHidden").value = String(paid));
  document.getElementById("modalChangeCashHidden") && (document.getElementById("modalChangeCashHidden").value = String(Math.max(0, change)));

  document.getElementById("modalCashNotEnough") &&
    document.getElementById("modalCashNotEnough").classList.toggle("hidden", paid >= total);
}

    // panel total
    const cashTotalLabel = document.getElementById("cashTotalLabel");
    if (cashTotalLabel) cashTotalLabel.textContent = formatIdr(total);

    // hidden inputs
    const paidHidden = document.getElementById("cashPaidHidden");
    const changeHidden = document.getElementById("cashChangeHidden");
    if (paidHidden) paidHidden.value = String(paid);
    if (changeHidden) changeHidden.value = String(Math.max(0, change));

    // summary modal fields
    const sumTotal = document.getElementById("sumTotal");
    const sumPaid = document.getElementById("sumPaid");
    const sumChange = document.getElementById("sumChange");
    if (sumTotal) sumTotal.textContent = formatIdr(total);
    if (sumPaid) sumPaid.textContent = formatIdr(paid);
    if (sumChange) sumChange.textContent = formatIdr(Math.max(0, change));

    const sumNotEnough = document.getElementById("sumNotEnough");
    if (sumNotEnough) sumNotEnough.classList.toggle("hidden", paid >= total);

    // keypad total label
    const keyTotal = document.getElementById("keyTotal");
    if (keyTotal) keyTotal.textContent = formatIdr(total);
  }

  // ===== Cash quick buttons =====
  function setCashAmount(amount) {
    paid = Number(amount || 0);
    keyValue = String(paid);
    updateCashUI();
  }

  function clearCash() {
    paid = 0;
    keyValue = "";
    renderKeyDisplay();
    updateCashUI();
  }

  // ===== Summary Cash Modal =====
  function openCashModal() {
    updateCashUI();
    const m = document.getElementById("cashModal");
    m.classList.remove("hidden");
    m.classList.add("flex");
  }

  function closeCashModal() {
    const m = document.getElementById("cashModal");
    m.classList.add("hidden");
    m.classList.remove("flex");
  }

  // زر OK داخل مودال الكاش (فقط إغلاق)
  function confirmCashOnly() {
    closeCashModal();
  }

  // ===== Manual Keypad Modal =====
  function openManualModal() {
    updateCashUI();

    // ابدأ بالـ paid الحالي
    keyValue = paid ? String(paid) : "";
    renderKeyDisplay();

    // افتح مودال الأرقام
    const m = document.getElementById("manualModal");
    m.classList.remove("hidden");
    m.classList.add("flex");
  }

  function closeManualModal() {
    const m = document.getElementById("manualModal");
    m.classList.add("hidden");
    m.classList.remove("flex");
  }

  function renderKeyDisplay() {
    const val = keyValue ? Number(keyValue) : 0;
    const d = document.getElementById("keyDisplay");
    if (d) d.textContent = formatIdr(val);
  }

  function appendKey(d) {
    if (keyValue.length >= 12) return;
    if (keyValue === "0") keyValue = "";
    keyValue += d;
    renderKeyDisplay();
  }

  function clearKey() {
    keyValue = "";
    renderKeyDisplay();
  }

  function confirmKey() {
    paid = keyValue ? Number(keyValue) : 0;
    updateCashUI();
    closeManualModal();
    // بعد إدخال المبلغ، نفتح ملخص الكاش مباشرة (اختياري)
    openCashModal();
  }

  // ===== Show/Hide cash panel based on payment radio (نفس طريقتك) =====
  function syncPaymentPanels() {
    const selected = document.querySelector('input[name="paymentRadio"]:checked')?.value;
    const cashPanel = document.getElementById("cashPanel");
    if (cashPanel) cashPanel.classList.toggle("hidden", selected !== "cash");
    if (selected === "cash") updateCashUI();
  }

  document.querySelectorAll('input[name="paymentRadio"]').forEach(r => {
    r.addEventListener("change", syncPaymentPanels);
  });

  // مهم: إذا totalDisplay يتغير مع السلة، راقب
  const totalEl = document.getElementById("totalDisplay");
  if (totalEl) {
    const obs = new MutationObserver(() => updateCashUI());
    obs.observe(totalEl, { childList: true, subtree: true, characterData: true });
  }

  // init
  syncPaymentPanels();
  updateCashUI();

  // مثال: زر الحفظ (استخدمه في مودال الدفع الأساسي عندك)
  function confirmPaymentAndSubmit() {
    const selected = document.querySelector('input[name="paymentRadio"]:checked')?.value;
    const total = getGrandTotalFromUI();

    if (selected === "cash" && paid < total) {
      alert("Uang tunai kurang dari total.");
      return;
    }

    // كمل منطق الحفظ عندك هنا
    // document.getElementById("yourFormId").submit();
  }
</script>
