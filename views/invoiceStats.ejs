<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .touch-scroll { -webkit-overflow-scrolling: touch; }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        surface: '#ffffff',
                        background: '#f3f4f6',
                        dark: '#111827',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background text-dark pb-10">

    <nav class="bg-surface shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center"> 
                <div class="flex items-center gap-3">
                    <div class="bg-primary/10 p-3 rounded-xl text-primary">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    </div>
                    <div>
                        <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900 tracking-tight">Dashboard</h1>
                    </div>
                </div>
                
                <button onclick="toggleStats()" class="flex items-center gap-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg font-bold transition-all shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                    <span id="toggleBtnText">Show Filter & Stats</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div id="statsContainer" class="hidden transition-all duration-300 ease-in-out">
            
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 mb-8">
                <div class="flex flex-col gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Filter Data</h2>
                    
                    <div class="flex flex-col md:flex-row gap-4 w-full items-end">
                        <% if(cabang === 'all') { %>
                        <div class="w-full md:w-1/4">
                            <label class="block text-sm font-semibold text-gray-500 mb-1">Pilih Cabang</label>
                            <select id="branchFilter" onchange="applyFilters()" class="w-full h-12 pl-4 pr-10 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary appearance-none font-bold text-gray-700">
                                <option value="all">Semua Cabang</option>
                                <% uniqueBranches.forEach(br => { %>
                                    <option value="<%= br %>"><%= br %></option>
                                <% }) %>
                            </select>
                        </div>
                        <% } %>

                        <div class="w-full md:w-1/4">
                            <label class="block text-sm font-semibold text-gray-500 mb-1">Pilih Tanggal</label>
                            <select id="dateRangeFilter" onchange="handleDateSelect()" class="w-full h-12 pl-4 pr-10 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary appearance-none font-bold text-gray-700">
                                <option value="all">Semua Tanggal</option>
                                <option value="today">Hari Ini</option>
                                <option value="1">1 Hari Terakhir</option>
                                <option value="3">3 Hari Terakhir</option>
                                <option value="7">1 Minggu</option>
                                <option value="30">1 Bulan</option>
                                <option value="custom">Custom Range (Dari - Sampai)</option>
                            </select>
                        </div>

                        <div id="customDateInputs" class="hidden flex-col md:flex-row gap-2 w-full md:w-2/4">
                            <div class="w-full">
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Dari</label>
                                <input type="date" id="startDate" onchange="applyFilters()" class="w-full h-12 px-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-primary">
                            </div>
                            <div class="w-full">
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Sampai</label>
                                <input type="date" id="endDate" onchange="applyFilters()" class="w-full h-12 px-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-primary">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 font-medium text-lg">Total Penjualan</p>
                        <h3 class="text-4xl font-extrabold text-gray-900 mt-2" id="displayTotalAmount"><%= totalAmount.toLocaleString('id-ID') %></h3>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                        <span class="text-2xl font-bold">Rp</span>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 font-medium text-lg">Total Transaksi</p>
                        <h3 class="text-4xl font-extrabold text-gray-900 mt-2" id="displayTotalCount"><%= totalInvoices %></h3>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 font-medium text-lg">Total Diskon</p>
                        <h3 class="text-4xl font-extrabold text-gray-900 mt-2" id="displayTotalDiscount"><%= totalDiscount.toLocaleString('id-ID') %></h3>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                </div>
            </div>

            <h3 class="text-xl font-bold text-gray-800 mb-4 px-1">Rincian Sumber & Pembayaran</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-8">
                <% for (const [key, val] of Object.entries(statsBySource)) { %>
                <div class="bg-white p-5 rounded-2xl border border-gray-200 shadow-sm flex flex-col justify-center text-center hover:shadow-md transition-shadow">
                    <span class="text-gray-500 text-sm font-semibold uppercase tracking-wider mb-1"><%= key %></span>
                    <span class="text-2xl font-bold text-gray-900"><%= val.total.toLocaleString('id-ID') %></span>
                    <span class="text-xs text-gray-400 mt-1"><%= val.count %> Transaksi</span>
                </div>
                <% } %>
            </div>
            
            <hr class="border-gray-200 my-8">
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50/50">
                <h3 class="text-2xl font-bold text-gray-800">Daftar Invoice</h3>
                <span class="text-sm text-gray-500 bg-white border px-3 py-1 rounded-full shadow-sm" id="rowCountBadge"><%= list.length %> baris</span>
            </div>
            
            <div class="overflow-x-auto touch-scroll">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4 align-bottom">
                                <div class="flex flex-col">
                                    <span class="text-xs font-medium text-gray-400 uppercase">Total:</span>
                                    <span id="headerTotalCount" class="text-lg font-extrabold text-blue-600 leading-tight">0</span>
                                    <span class="text-xs font-bold text-gray-500 uppercase mt-1">No. Invoice</span>
                                </div>
                            </th>
                            <th class="px-6 py-4 text-sm font-bold text-gray-500 uppercase align-bottom">Cabang</th>
                            <th class="px-6 py-4 text-sm font-bold text-gray-500 uppercase align-bottom">Waktu</th>
                            <th class="px-6 py-4 text-sm font-bold text-gray-500 uppercase align-bottom">Customer</th>
                            <th class="px-6 py-4 text-sm font-bold text-gray-500 uppercase align-bottom">Sumber</th>
                            <th class="px-6 py-4 align-bottom text-right">
                                <div class="flex flex-col items-end">
                                    <span class="text-xs font-medium text-gray-400 uppercase">Total Diskon:</span>
                                    <span id="headerTotalDiscount" class="text-lg font-extrabold text-red-500 leading-tight">0</span>
                                    <span class="text-xs font-bold text-gray-500 uppercase mt-1">Diskon</span>
                                </div>
                            </th>
                            <th class="px-6 py-4 align-bottom text-right">
                                <div class="flex flex-col items-end">
                                    <span class="text-xs font-medium text-gray-400 uppercase">Grand Total:</span>
                                    <span id="headerTotalAmount" class="text-lg font-extrabold text-gray-900 leading-tight">0</span>
                                    <span class="text-xs font-bold text-gray-500 uppercase mt-1">Total</span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100" id="invoiceTableBody">
                        <% list.forEach((inv) => { %>
                        <tr class="invoice-row hover:bg-blue-50/50 transition-colors group"
                            data-date="<%= inv.finishedAt %>"
                            data-amount="<%= inv.total || 0 %>"
                            data-discount="<%= inv.discount || 0 %>"
                            data-cabang="<%= inv.cabang %>">
                            
                            <td class="px-6 py-5 whitespace-nowrap">
                                <span class="text-lg font-mono font-bold text-primary group-hover:underline">
                                    #<%= inv.invoiceNumber %>
                                </span>
                            </td>
                            <td class="px-6 py-5 whitespace-nowrap">
                                <span class="px-3 py-1 text-sm font-bold rounded-lg bg-gray-200 text-gray-700">
                                    <%= inv.cabang %>
                                </span>
                            </td>
                            <td class="px-6 py-5 whitespace-nowrap">
                                <div class="text-lg font-medium text-gray-900"><%= new Date(inv.finishedAt).toLocaleDateString('id-ID') %></div>
                                <div class="text-sm text-gray-400"><%= new Date(inv.finishedAt).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}) %></div>
                            </td>
                            <td class="px-6 py-5 whitespace-nowrap">
                                <div class="text-lg font-medium text-gray-800"><%= inv.customerName || 'Guest' %></div>
                            </td>
                            <td class="px-6 py-5 whitespace-nowrap">
                                <% 
                                   let displaySource = inv.source || 'Unknown';
                                   let badgeColor = 'bg-orange-100 text-orange-800';
                                   if(displaySource.toLowerCase() === 'instore') {
                                        displaySource = inv.paymentMethod || 'Cash';
                                        badgeColor = 'bg-purple-100 text-purple-800';
                                   } else if (displaySource.toLowerCase().includes('gojek') || displaySource.toLowerCase().includes('grab')) {
                                        badgeColor = 'bg-green-100 text-green-800';
                                   }
                                %>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-base font-bold <%= badgeColor %>">
                                    <%= displaySource %>
                                </span>
                            </td>
                             <td class="px-6 py-5 whitespace-nowrap text-right">
                                <span class="text-lg font-medium text-red-500">
                                    <%= (inv.discount || 0).toLocaleString('id-ID') %>
                                </span>
                            </td>
                            <td class="px-6 py-5 whitespace-nowrap text-right">
                                <span class="text-xl font-black text-gray-900">
                                    <%= (inv.total || 0).toLocaleString('id-ID') %>
                                </span>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            <div id="noDataMessage" class="hidden text-center py-12">
                <p class="text-xl text-gray-400 font-medium">Tidak ada data untuk filter ini</p>
            </div>
        </div>
    </main>

    <script>
        // إعداد التواريخ الافتراضية لحقول التاريخ المخصصة (اليوم)
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            applyFilters(); // تطبيق الفلتر الأولي لملء الإحصائيات
        };

        function toggleStats() {
            const container = document.getElementById('statsContainer');
            const btnText = document.getElementById('toggleBtnText');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                btnText.innerText = "Hide Filter & Stats";
            } else {
                container.classList.add('hidden');
                btnText.innerText = "Show Filter & Stats";
            }
        }

        function handleDateSelect() {
            const select = document.getElementById('dateRangeFilter');
            const customInputs = document.getElementById('customDateInputs');
            
            if (select.value === 'custom') {
                customInputs.classList.remove('hidden');
                customInputs.classList.add('flex');
            } else {
                customInputs.classList.add('hidden');
                customInputs.classList.remove('flex');
                applyFilters(); // تطبيق الفلتر مباشرة إذا لم يكن مخصصاً
            }
        }

        function applyFilters() {
            const dateFilter = document.getElementById('dateRangeFilter').value;
            const branchSelect = document.getElementById('branchFilter');
            const branchFilter = branchSelect ? branchSelect.value : 'all';

            // قيم التاريخ المخصص
            const startDateVal = document.getElementById('startDate').value;
            const endDateVal = document.getElementById('endDate').value;

            const rows = document.querySelectorAll('.invoice-row');
            
            let visibleCount = 0;
            let visibleAmount = 0;
            let visibleDiscount = 0;

            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            rows.forEach(row => {
                const rowDateStr = row.getAttribute('data-date');
                const rowCabang = row.getAttribute('data-cabang');
                const rowAmount = parseFloat(row.getAttribute('data-amount'));
                const rowDiscount = parseFloat(row.getAttribute('data-discount'));
                const rowDate = new Date(rowDateStr);
                
                // 1. فحص التاريخ
                let dateMatch = false;
                if (dateFilter === 'all') {
                    dateMatch = true;
                } else if (dateFilter === 'today') {
                    dateMatch = rowDate >= todayStart;
                } else if (dateFilter === 'custom') {
                    // منطق التاريخ المخصص
                    if(startDateVal && endDateVal) {
                        const start = new Date(startDateVal);
                        const end = new Date(endDateVal);
                        end.setHours(23, 59, 59); // لنشمل نهاية اليوم
                        dateMatch = rowDate >= start && rowDate <= end;
                    } else {
                        dateMatch = true; // إظهار الكل إذا لم يتم تحديد تواريخ
                    }
                } else {
                    const daysAgo = parseInt(dateFilter);
                    const cutoffDate = new Date(now);
                    cutoffDate.setDate(now.getDate() - daysAgo);
                    dateMatch = rowDate >= cutoffDate;
                }

                // 2. فحص الفرع
                let branchMatch = false;
                if (branchFilter === 'all') {
                    branchMatch = true;
                } else {
                    branchMatch = (rowCabang === branchFilter);
                }

                if (dateMatch && branchMatch) {
                    row.style.display = ''; 
                    visibleCount++;
                    visibleAmount += rowAmount;
                    visibleDiscount += rowDiscount;
                } else {
                    row.style.display = 'none';
                }
            });

            const noDataMsg = document.getElementById('noDataMessage');
            if (visibleCount === 0) {
                noDataMsg.classList.remove('hidden');
            } else {
                noDataMsg.classList.add('hidden');
            }

            updateStats(visibleAmount, visibleCount, visibleDiscount);
        }

        function updateStats(amount, count, discount) {
            // تحديث البطاقات الكبيرة (حتى لو كانت مخفية)
            document.getElementById("displayTotalAmount").innerText = amount.toLocaleString('id-ID');
            document.getElementById("displayTotalCount").innerText = count;
            document.getElementById("displayTotalDiscount").innerText = discount.toLocaleString('id-ID');
            
            // تحديث إجماليات رأس الجدول
            document.getElementById("headerTotalAmount").innerText = amount.toLocaleString('id-ID');
            document.getElementById("headerTotalCount").innerText = count;
            document.getElementById("headerTotalDiscount").innerText = discount.toLocaleString('id-ID');

            // تحديث شارة عدد الصفوف
            document.getElementById("rowCountBadge").innerText = count + " baris";
        }
    </script>
</body>
</html>