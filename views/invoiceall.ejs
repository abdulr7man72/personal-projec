<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#4f46e5" />
    <meta name="description" content="نظام إدارة الفواتير والمبيعات" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="الفواتير" />
    <link rel="apple-touch-icon" href="/images/icon-192.png" />
    <link rel="manifest" href="/manifest.json" />
    <title><%= title || "Invoices" %></title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      @media print {
        body {
          background: #ffffff;
        }
        .no-print {
          display: none !important;
        }
        .page-wrap {
          max-width: 100%;
          margin: 0;
          padding: 0;
        }
      }
    </style>
  </head>

  <body class="bg-slate-100 text-slate-800">
    <div class="flex min-h-screen">

      <!-- Sidebar -->
      <%- include('articles/side.ejs') %>

      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-btn"
        class="lg:hidden fixed top-4 right-4 z-30 p-2 bg-white rounded-lg shadow-lg text-slate-700 hover:bg-slate-100 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
          viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>

      <!-- Mobile Sidebar Overlay -->
      <div id="mobile-overlay"
        class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-20 hidden transition-opacity"></div>

      <!-- Mobile Sidebar -->
      <aside
        id="mobile-sidebar"
        class="lg:hidden fixed top-0 right-0 h-full w-64 bg-white shadow-2xl z-30 transform translate-x-full transition-transform duration-300 p-4">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-indigo-600">القائمة</h2>
          <button id="close-mobile-menu"
            class="p-2 rounded-lg text-slate-700 hover:bg-slate-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
              viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round"
                stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <nav>
          <ul class="space-y-2">
            <li>
              <a href="/purchases"
                class="flex items-center p-2 rounded-lg text-slate-700 hover:bg-slate-100 hover:text-indigo-600 font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3"
                  fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6m-6 0v-5m6 5v-5" />
                </svg>
                <span class="mr-3">الرئيسية</span>
              </a>
            </li>
            <li>
              <a href="/<%= cabang %>/pos"
                class="flex items-center p-2 rounded-lg text-slate-700 hover:bg-slate-100 hover:text-indigo-600 font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3"
                  fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    stroke-width="2" d="M6 18h2" />
                  <path d="M12 18h6" />
                  <rect width="14" height="8" x="5" y="2" rx="2" />
                  <rect width="20" height="8" x="2" y="14" rx="2" />
                </svg>
                <span class="mr-3">كاشير</span>
              </a>
            </li>
                        <li>
              <a href="/<%= cabang %>/invoicall"
                class="flex items-center p-2 rounded-lg text-slate-700 hover:bg-slate-100 hover:text-indigo-600 font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3"
                  fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    stroke-width="2" d="M9 7h6m0 10v-3m-6 3v-3m-6-4h12a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2V9a2 2 0 012-2zm9-3V5a2 2 0 00-2-2h-2a2 2 0 00-2 2v2m0 0a2 2 0 00-2 2v3h8V9a2 2 0 00-2-2z" />
                </svg>
                <span class="mr-3">الفواتير</span>
              </a>
            </li>
            <li>
              <a href="/<%= cabang %>/stats"
                class="flex items-center p-2 rounded-lg text-slate-700 hover:bg-slate-100 hover:text-indigo-600 font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3"
                  fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    stroke-width="2"
                    d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                  <path stroke-linecap="round" stroke-linejoin="round"
                    stroke-width="2"
                    d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                </svg>
                <span class="mr-3">إحصائيات <%= cabang %></span>
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <div id="main-content"
        class="page-wrap flex-grow w-full mx-auto p-3 sm:p-4 md:p-6 transition-all duration-300 ease-in-out">

        <header
          class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4 sm:mb-6">
          <h1 class="text-xl sm:text-2xl md:text-3xl font-bold">
            <span class="uppercase text-indigo-600"><%= cabang %></span>
          </h1>
        </header>

        <div id="invoice-grid"
          class="grid gap-3 sm:gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5">
        </div>
      </div>
    </div>

    <script>

      // Invoice Management
      const CABANG = "<%= cabang %>";

      async function refreshInvoices() {
        try {
          const res = await fetch(`/${CABANG}/invoiceall/json`);
          if (!res.ok) return;
          const data = await res.json();
          renderInvoices(data);
        } catch (e) {
          console.error("Failed to refresh invoices", e);
        }
      }

      function renderInvoices(list) {
        const container = document.getElementById("invoice-grid");
        if (!container) return;
        container.innerHTML = "";

        let number = 1;
        list.forEach(inv => {
          const items = inv.items || [];
          const discount = inv.discount || 0;
          const total = inv.total || 0;
          const subtotal = total + discount;
          const source = inv.paymentMethod || "";
          const modalPaidCash = inv.modalPaidCash || 0;
          const modalChangeCash = inv.modalChangeCash || 0;

          const wrapper = document.createElement("div");
          wrapper.className = "flex justify-center";

          wrapper.innerHTML = `
            <div
              id="invoice-${inv._id}"
              class="bg-white w-full rounded-2xl shadow-sm border border-slate-200 px-3 sm:px-4 pt-3 pb-0 flex flex-col transition-shadow hover:shadow-md"
            >
              <div class="flex items-start justify_between gap-2 mb-2">
                <div class="text-[11px] leading-snug flex-1 min-w-0">
                  <div class="text-sm sm:text-base font-semibold text-slate-900 truncate">
                    ${number++}
                  </div>
                  ${inv.customerName ? `
                    <div class="mt-1 text-slate-700">
                      <div class="text-[10px] uppercase tracking-wide text-slate-500">
                        PELANGGAN
                      </div>
                      <div class="text-[11px] font-semibold truncate invoice-customer">
                        ${inv.customerName}
                      </div>
                    </div>` : ""}
                </div>

                <div class="text-right shrink-0">
                  <div class="font-mono text-lg sm:text-xl font-extrabold tracking-wide text-slate-900 leading-none invoice-number">
                    #${inv.invoiceNumber || ""}
                  </div>
                  <div class="mt-1 text-[10px] text-slate-600 invoice-date">
                    ${inv.date ? new Date(inv.date).toLocaleDateString("id-ID") : ""}
                  </div>
                  ${inv.source ? `
                    <div class="mt-0.5 text-[10px] text-slate-500 capitalize invoice-source">
                      ${inv.source}
                    </div>` : ""}
                    <div class="mt-0.5 text-[30x] capitalize invoice-codePin">
                      ${inv.codePin || ""}
                    </div>
                </div>
              </div>


              <div class="border-t border-dotted border-slate-300 my-2"></div>

              <!-- هنا تم إزالة max-h-32 و overflow-y-auto و no-scrollbar -->
              <div class="space-y-1.5 pr-1 invoice-items">
                ${items.map(it => `
                  <div class="flex justify-between gap-2">
                    <div class="flex-1 min-w-0">
                      <div class="text-[11px] font-semibold text-slate-900 truncate">
                        ${it.name || ""} 
                      </div>
                      <div class="text-[10px] text-slate-500 space-y-0.5">
                        <div>
                          ${(it.quantity || 1)}x · 
                          Rp ${(it.unitPrice || it.subtotal || 0).toLocaleString("id-ID")}
                        </div>
                        ${it.note ? `<div class="truncate">Note: ${it.note}</div>` : ""}
                        ${(it.addons && it.addons.length)
                          ? `<div class="truncate">Add-ons: ${it.addons.join(", ")}</div>`
                          : ""}
                      </div>
                    </div>
                    <div class="text-right text-[11px] font-mono text-slate-900 min-w-[72px] shrink-0">
                      Rp ${(it.subtotal || (it.unitPrice || 0) * (it.quantity || 1)).toLocaleString("id-ID")}
                    </div>
                  </div>
                `).join("")}
              </div>

              <div class="border-t border-slate-200 mt-3 pt-2 space-y-1 text-[11px] w-full invoice-totals">
                <div class="flex justify-between">
                  <span class="text-slate-500">Sub-total</span>
                  <span class="font-mono text-slate-800">
                    Rp ${subtotal.toLocaleString("id-ID")}
                  </span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-500">Discount</span>
                  <span class="font-mono text-slate-800">
                    Rp ${discount.toLocaleString("id-ID")}
                  </span>
                </div>
                <div class="flex justify-between pt-1 border-t border-slate-200 mt-1 mb-1">
                  <span class="font-semibold text-slate-900">Total</span>
                  <span class="font-mono font-semibold text-slate-900">
                    Rp ${total.toLocaleString("id-ID")}
                  </span>
                </div>
              </div>

              <div class="border-t border-slate-200 mt-3 pt-2 space-y-1 text-[11px] w-full invoice-cash">
                <div class="flex justify-between">
                  <span class="text-slate-500">${source.toLocaleString("id-ID") ? "pembayaran " + source : ""}</span>
                  <span class="font-mono text-slate-800">
                   ${source.toLocaleString("id-ID") || ""}
                  </span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-500">${modalPaidCash !== 0 && source === "cash" ? "di bayar" : ""}</span>
                  <span class="font-mono text-slate-800">
                  ${source === "cash" && modalPaidCash !== 0
                  ? `Rp ${modalPaidCash.toLocaleString("id-ID")}`: ""}

                  </span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-500">${modalPaidCash !== 0 && source === "cash" ? "kembalian" : ""}</span>
                  <span class="font-mono text-slate-800">
                  ${modalPaidCash !== 0 && source === "cash" && modalPaidCash !== 0
                  ? `Rp ${modalChangeCash.toLocaleString("id-ID")}`: ""}

                  </span>
                </div>

              </div>
              <br>

              <div class="no-print mt-auto -mx-3 sm:-mx-4">
                <div class="grid grid-cols-4 text-[11px] font-medium text-white rounded-b-2xl overflow-hidden">
                  <form action="/${CABANG}/invoiceall/${inv._id}/done" method="POST">
                    <button
                      type="submit"
                      class="w-full h-full py-2 bg-slate-900 hover:bg-slate-950 transition-colors"
                    >
                      Selesai
                    </button>
                  </form>

                  <a
                    href="/${CABANG}/invoiceall/${inv._id}/edit"
                    class="w-full h-full flex items-center justify-center py-2 bg-amber-500 hover:bg-amber-600 transition-colors"
                  >
                    Edit
                  </a>

                  <form action="/${CABANG}/invoiceall/${inv._id}/delete" method="POST">
                    <button
                      type="submit"
                      class="w-full h-full py-2 bg-red-700 hover:bg-red-800 transition-colors"
                    >
                      Hapus
                    </button>
                  </form>

                  <button
                    type="button"
                    class="py-2 bg-emerald-600 hover:bg-emerald-700 transition-colors"
                    onclick="printInvoice('${inv._id}')"
                  >
                    Print
                  </button>
                </div>
              </div>

            </div>
          `;

          container.appendChild(wrapper);
        });
      }

      refreshInvoices();
      setInterval(refreshInvoices, 2000);

      function printInvoice(id) {
        const card = document.getElementById("invoice-" + id);
        if (!card) return;

        const invoiceNumberRaw = card.querySelector(".invoice-number")?.textContent.trim() || "";
        const invoiceNumber = invoiceNumberRaw.replace("#", "").trim();
        const invoiceDate = card.querySelector(".invoice-date")?.textContent.trim() || "";
        const invoiceSource = card.querySelector(".invoice-source")?.textContent.trim() || "";
        const invoiceCustomer = card.querySelector(".invoice-customer")?.textContent.trim() || "";
        const codePin = card.querySelector(".invoice-codePin")?.textContent.trim() || "";
        const itemsHtml = card.querySelector(".invoice-items")?.innerHTML || "";
        const totalsHtml = card.querySelector(".invoice-totals")?.innerHTML || "";
        const cashHtml = card.querySelector(".invoice-cash")?.innerHTML || "";

        const win = window.open("", "_blank", "width=400,height=700");
        win.document.write(`
          <html>
            <head>
              <title>Invoice</title>
              <style>
                * {
                  box-sizing: border-box;
                }
                body {
                  margin: 0;
                  padding: 0;
                  font-family: Arial, sans-serif;
                  background: #ffffff;
                  font-size: 11px;
                  color: #000;
                }
                .receipt {
                  max-width: 320px;
                  margin: 0 auto;
                  padding: 10px;
                  background: white;
                  color: black;
                }
                .receipt-box {
                  border: 1px solid #000;
                  padding: 10px;
                  background: white;
                }
                .receipt-header {
                  text-align: center;
                  margin-bottom: 8px;
                  border-bottom: 2px solid #000;
                  padding-bottom: 8px;
                }
                .receipt-header h1 {
                  margin: 0;
                  font-size: 14px;
                  font-weight: bold;
                  text-transform: uppercase;
                }
                .receipt-header .branch {
                  font-size: 11px;
                  color: #000;
                  margin-top: 3px;
                }
                .receipt-header .inv {
                  font-family: monospace;
                  font-size: 12px;
                  font-weight: bold;
                  margin-top: 3px;
                }
                .meta {
                  margin-top: 6px;
                  margin-bottom: 6px;
                  font-size: 10px;
                }
                .meta-row {
                  display: flex;
                  justify-content: space-between;
                  margin-bottom: 2px;
                  font-size: 10px;
                }
                .meta-label {
                  color: #000;
                  font-weight: bold;
                }
                .meta-value {
                  font-weight: normal;
                }
                .section-title {
                  font-size: 11px;
                  text-transform: uppercase;
                  color: #000;
                  margin-top: 6px;
                  margin-bottom: 4px;
                  border-bottom: 1px solid #000;
                  padding-bottom: 2px;
                  font-weight: bold;
                }
                .meta-value2 {
                  font-size: 15px;
                }
                .items {
                  font-size: 10px;
                }
                .items > div {
                  margin-bottom: 3px;
                  border-bottom: 1px dotted #ccc;
                  padding-bottom: 2px;
                  display: flex;
                  justify-content: space-between;
                  gap: 10px;
                }
                .totals {
                  margin-top: 6px;
                  font-size: 10px;
                }
                .totals > div {
                  margin-bottom: 2px;
                  display: flex;
                  justify-content: space-between;
                }
                .receipt-footer {
                  margin-top: 10px;
                  font-size: 10px;
                  text-align: center;
                  color: #000;
                  border-top: 1px solid #000;
                  padding-top: 6px;
                }
                @media print {
                  body {
                    background: #ffffff;
                    margin: 0;
                    padding: 0;
                  }
                  .receipt {
                    max-width: 80mm;
                  }
                }
              </style>
            </head>
            <body>
              <div class="receipt">
                <div class="receipt-box">
                  <div class="receipt-header">
                    <h1>The Shawarma</h1>
                    <div class="branch">Cabang: ${CABANG.toUpperCase() === "BGR01" ? "BOGOR PERMAI" : CABANG.toUpperCase() === "SPL01" ? "SEMPLAK" : CABANG.toUpperCase()}</div>
                    <div class="inv">INV: ${invoiceNumber || "-"}</div>
                  </div>

                  <div class="meta">
                    ${invoiceDate ? `
                      <div class="meta-row">
                        <span class="meta-label">Tanggal</span>
                        <span class="meta-value">${invoiceDate}</span>
                      </div>` : ""}
                    ${invoiceSource ? `
                      <div class="meta-row">
                        <span class="meta-label">Channel</span>
                        <span class="meta-value">${invoiceSource}</span>
                      </div>` : ""}
                    ${invoiceCustomer ? `
                      <div class="meta-row">
                        <span class="meta-label">Pelanggan</span>
                        <span class="meta-value">${invoiceCustomer}</span>
                      </div>` : ""}
                    ${codePin ? `
                      <div class="meta-row">
                        <span class="meta-label">Code Pin</span>
                        <span class="meta-value2">${codePin}</span>
                      </div>` : ""}
                  </div>

                  <div class="section-title">Detail Pesanan</div>
                  <div class="items">
                    ${itemsHtml}
                  </div>

                  <div class="section-title">Ringkasan</div>
                  <div class="totals">
                    ${totalsHtml}
                  </div>
                  <div class="section-title"></div>
                  <div class="totals">
                    ${cashHtml}
                  </div>

                </div>
              </div>
            </body>
          </html>
        `);
        win.document.close();

        win.onload = function () {
          win.focus();
          win.print();
          win.close();
        };
      }
    </script>

    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js').then(reg => {
            console.log('✅ Service Worker registered:', reg);
          }).catch(err => {
            console.error('❌ Service Worker registration failed:', err);
          });
        });
      }

      // طلب إذن إضافة التطبيق
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showInstallPrompt();
      });

      function showInstallPrompt() {
        // يمكنك إضافة زر أو رسالة تثبيت هنا
        console.log('التطبيق متاح للتثبيت');
      }

      window.addEventListener('appinstalled', () => {
        console.log('✅ تم تثبيت التطبيق بنجاح');
        deferredPrompt = null;
      });
    </script>
  </body>
</html>
