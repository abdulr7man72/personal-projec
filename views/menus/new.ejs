<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>New Menu</title>
  <style>
    *{box-sizing:border-box} body{font-family:system-ui,Arial,sans-serif;margin:0;background:#f8fafc}
    .wrap{max-width:980px;margin:24px auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:16px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns: repeat(2,minmax(0,1fr))}
    .g4{grid-template-columns: repeat(4,minmax(0,1fr))}
    label{display:block;font-size:12px;color:#475569;margin-bottom:4px}
    input{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    .row{display:flex;gap:10px;align-items:center}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#0ea5e9;color:#fff;cursor:pointer}
    .btn.secondary{background:#fff;color:#0ea5e9}
    .btn.ghost{background:#fff;color:#334155}
    .muted{color:#64748b;font-size:12px}
    .title{font-size:18px;font-weight:700;margin:0 0 14px}
    .hr{height:1px;background:#e5e7eb;margin:14px 0}
    .addon-row{display:grid;grid-template-columns: 1.2fr repeat(4,1fr) 90px; gap:10px; align-items:end}
    .addon-header{display:grid;grid-template-columns: 1.2fr repeat(4,1fr) 90px; gap:10px; font-size:12px;color:#475569;margin-bottom:6px}
    pre{background:#0b1220;color:#e5e7eb;border-radius:12px;padding:12px;overflow:auto;min-height:110px}
    img.preview{width:160px;height:110px;object-fit:cover;border:1px solid #e5e7eb;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2 class="title">Create Menu Item</h2>

      <div class="grid g2">
        <div>
          <label for="name">Name</label>
          <input id="name" placeholder="Shawarma Jumbo"/>
        </div>
        <div>
          <label for="catagory">Catagory (as schema)</label>
          <input id="catagory" placeholder="shawarma"/>
        </div>
      </div>

      <div class="grid g2" style="align-items:center">
        <div>
          <label for="imageUrl">Image URL</label>
          <input id="imageUrl" placeholder="https://..."/>
        </div>
        <div class="row" style="gap:16px">
          <img id="imgPreview" class="preview" alt="preview"/>
          <button type="button" class="btn ghost" id="btnPreview">Preview Image</button>
        </div>
      </div>

      <div class="hr"></div>

      <h3 class="title" style="font-size:16px">Base Prices</h3>
      <div class="grid g4">
        <div>
          <label for="price_inStore">inStore</label>
          <input id="price_inStore" type="number" min="0" placeholder="30000"/>
        </div>
        <div>
          <label for="price_goFood">goFood</label>
          <input id="price_goFood" type="number" min="0" placeholder="36000"/>
        </div>
        <div>
          <label for="price_grabFood">grabFood</label>
          <input id="price_grabFood" type="number" min="0" placeholder="36000"/>
        </div>
        <div>
          <label for="price_shopeeFood">shopeeFood</label>
          <input id="price_shopeeFood" type="number" min="0" placeholder="36900"/>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between">
        <h3 class="title" style="font-size:16px;margin:0">Addons</h3>
        <button type="button" class="btn secondary" id="btnAddAddon">+ Add addon</button>
      </div>

      <div class="addon-header">
        <div>Addon Name</div>
        <div>inStore</div>
        <div>goFood</div>
        <div>grabFood</div>
        <div>shopeeFood</div>
        <div>Action</div>
      </div>
      <div id="addonsBox" class="grid" style="gap:10px"></div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between">
        <button type="button" class="btn ghost" id="btnPreviewJSON">Preview JSON</button>
        <div class="row">
          <a class="btn secondary" href="/menus">Back</a>
          <button type="button" class="btn" id="btnSubmit">Save</button>
        </div>
      </div>

      <label>JSON Preview</label>
      <pre id="jsonPreview"></pre>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const addonsBox = $('#addonsBox');
    const preview = $('#jsonPreview');
    const imgPreview = $('#imgPreview');
    const toNum = v => { const n = Number(v); return Number.isFinite(n) ? n : 0; };

    function newAddonRow(data=null){
      const row = document.createElement('div');
      row.className = 'addon-row';
      row.innerHTML = `
        <div><input placeholder="pedas" class="ad-name" value="${data?.name ?? ''}"></div>
        <div><input type="number" min="0" placeholder="2000" class="ad-instore" value="${data?.prices?.inStore ?? ''}"></div>
        <div><input type="number" min="0" placeholder="2400" class="ad-gofood" value="${data?.prices?.goFood ?? ''}"></div>
        <div><input type="number" min="0" placeholder="2400" class="ad-grabfood" value="${data?.prices?.grabFood ?? ''}"></div>
        <div><input type="number" min="0" placeholder="2500" class="ad-shopeefood" value="${data?.prices?.shopeeFood ?? ''}"></div>
        <div><button type="button" class="btn ghost btn-del">Del</button></div>
      `;
      row.querySelector('.btn-del').addEventListener('click', () => row.remove());
      addonsBox.appendChild(row);
    }

    $('#btnAddAddon').addEventListener('click', () => newAddonRow());

    $('#btnPreview').addEventListener('click', () => {
      const url = $('#imageUrl').value.trim();
      imgPreview.src = url || '';
    });

    function buildPayload(){
      const payload = {
        name: $('#name').value.trim(),
        prices: {
          inStore: toNum($('#price_inStore').value),
          goFood: toNum($('#price_goFood').value),
          grabFood: toNum($('#price_grabFood').value),
          shopeeFood: toNum($('#price_shopeeFood').value),
        },
        addons: [],
        catagory: $('#catagory').value.trim(), // كما السكيمة
        imageUrl: $('#imageUrl').value.trim()
      };

      addonsBox.querySelectorAll('.addon-row').forEach(row => {
        const name = row.querySelector('.ad-name').value.trim();
        if(!name) return;
        payload.addons.push({
          name,
          prices: {
            inStore: toNum(row.querySelector('.ad-instore').value),
            goFood: toNum(row.querySelector('.ad-gofood').value),
            grabFood: toNum(row.querySelector('.ad-grabfood').value),
            shopeeFood: toNum(row.querySelector('.ad-shopeefood').value),
          }
        });
      });

      return payload;
    }

    $('#btnPreviewJSON').addEventListener('click', () => {
      const data = buildPayload();
      preview.textContent = JSON.stringify(data, null, 2);
    });

    $('#btnSubmit').addEventListener('click', async () => {
      const data = buildPayload();
      preview.textContent = JSON.stringify(data, null, 2);
      try{
        const res = await fetch('/menus', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(data)
        });
        if(res.ok){
          alert('✅ Saved'); location.href = '/menus';
        }else{
          const out = await res.json().catch(()=>({}));
          alert('❌ Failed: ' + (out.message || res.status));
        }
      }catch(err){
        console.error(err);
        alert('❌ Network error');
      }
    });

    // صف افتراضي
    newAddonRow({ name:'pedas', prices:{ inStore:2000, goFood:2400, grabFood:2400, shopeeFood:2500 }});
  </script>
</body>
</html>
