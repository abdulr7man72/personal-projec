<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#f97316" />
  <meta name="description" content="Statistik Pembelian - Sistem Manajemen Pembelian" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Statistik Pembelian" />
  <link rel="apple-touch-icon" href="/images/icon-192.png" />
  <link rel="manifest" href="/manifest.json" />
  <title>Statistik Pembelian</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

  <style>
    body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
    .touch-scroll { -webkit-overflow-scrolling: touch; }
    /* Hide scrollbar for all browsers */
    ::-webkit-scrollbar { display: none; }
    * { -ms-overflow-style: none; scrollbar-width: none; }
    .purchase-row { transition: background-color 0.2s ease; }
    .source-card { transition: all 0.2s ease; }
    .source-card.active { background: linear-gradient(135deg,#fb923c 0%,#f97316 100%); border-color:#f97316; color: white; }
    .source-card.active .src-count, .source-card.active .src-total { color: white; }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#f97316',
            primary2: '#fb923c',
            surface: '#ffffff',
            background: '#f8fafc',
            dark: '#111827',
          }
        }
      }
    }
  </script>
</head>

<body class="bg-background text-dark overflow-hidden">
  <div class="h-screen flex">

    <!-- ✅ ASIDE -->
    <%- include('articles/side.ejs') %>

    <!-- ✅ Content -->
    <div class="flex-1 min-w-0 flex flex-col h-screen">

      <!-- ✅ Desktop Navbar -->
      <nav class="hidden lg:block bg-white border-b border-slate-200 sticky top-0 z-40">
        <div class="h-16 flex items-center justify-between px-4">
          <div class="flex items-center gap-3">
            <div class="p-3 rounded-xl text-white bg-gradient-to-r from-primary to-primary2 shadow-sm">
              <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
              </svg>
            </div>
            <div class="leading-tight">
              <h1 class="text-lg sm:text-xl font-extrabold text-slate-900 tracking-tight">Statistik Pembelian</h1>
              <div class="text-xs text-slate-500 font-semibold">
                <% if(currentBranch === 'all') { %>
                  Semua Cabang
                <% } else { %>
                  Cabang: <%= currentBranch %>
                <% } %>
              </div>
            </div>
          </div>

          <!-- ✅ Back button -->
          <a href="/purchases" class="flex items-center gap-2 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded-xl font-extrabold transition-all">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            <span>Kembali</span>
          </a>
        </div>
      </nav>

      <!-- ✅ Filter Data (فقط للشاشات الكبيرة) -->
      <div id="statsContainer" class="hidden lg:block shrink-0 border-b border-slate-200 bg-white">
        <div class="p-3 lg:p-4">
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3 lg:p-4">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-base font-extrabold text-slate-900">Filter Data</h2>
              <span class="text-[11px] text-slate-500 font-semibold">Reset untuk semua data</span>
            </div>

            <div class="flex flex-col md:flex-row gap-3 w-full items-end">
              <% if(currentBranch === 'all') { %>
              <div class="w-full md:w-1/4">
                <label class="block text-xs font-bold text-slate-600 mb-1">Pilih Cabang</label>
                <select id="branchFilter" onchange="applyFilters()"
                  class="w-full h-11 px-3 bg-white border border-slate-200 rounded-xl font-extrabold text-slate-800
                         focus:ring-2 focus:ring-orange-400 focus:border-orange-400 appearance-none cursor-pointer">
                  <option value="all">Semua Cabang</option>
                  <% uniqueBranches.forEach(br => { %>
                    <option value="<%= br %>"><%= br %></option>
                  <% }) %>
                </select>
              </div>
              <% } %>

              <div class="w-full md:w-1/4">
                <label class="block text-xs font-bold text-slate-600 mb-1">Pilih Tanggal</label>
                <select id="dateRangeFilter" onchange="handleDateSelect()"
                  class="w-full h-11 px-3 bg-white border border-slate-200 rounded-xl font-extrabold text-slate-800
                         focus:ring-2 focus:ring-orange-400 focus:border-orange-400 appearance-none cursor-pointer">
                  <option value="all">Semua Tanggal</option>
                  <option value="today">Hari Ini</option>
                  <option value="1">1 Hari Terakhir</option>
                  <option value="3">3 Hari Terakhir</option>
                  <option value="7">1 Minggu</option>
                  <option value="30">1 Bulan</option>
                  <option value="custom">Custom Range</option>
                </select>
              </div>

              <div id="customDateInputs" class="hidden flex-col md:flex-row gap-2 w-full md:w-2/4">
                <div class="w-full">
                  <label class="block text-xs font-bold text-slate-600 mb-1">Dari</label>
                  <input type="date" id="startDate" onchange="applyFilters()"
                    class="w-full h-11 px-3 bg-white border border-slate-200 rounded-xl text-slate-800
                           focus:ring-2 focus:ring-orange-400 focus:border-orange-400">
                </div>
                <div class="w-full">
                  <label class="block text-xs font-bold text-slate-600 mb-1">Sampai</label>
                  <input type="date" id="endDate" onchange="applyFilters()"
                    class="w-full h-11 px-3 bg-white border border-slate-200 rounded-xl text-slate-800
                           focus:ring-2 focus:ring-orange-400 focus:border-orange-400">
                </div>
              </div>

              <button type="button" onclick="resetFilters()"
                class="h-11 px-4 rounded-xl font-extrabold text-white bg-gradient-to-r from-primary to-primary2
                       hover:opacity-95 active:scale-95 transition">
                Reset
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ WORKSPACE -->
      <div class="flex-1 overflow-hidden">

        <!-- MOBILE LAYOUT ========================= -->
        <div class="lg:hidden h-full flex flex-col pt-14">

          <!-- ✅ Back Button Mobile -->
          <div class="shrink-0 bg-white border-b border-slate-200 px-3 py-2">
            <a href="/purchases" class="flex items-center gap-2 text-slate-700 font-bold">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
              </svg>
              Kembali ke Daftar
            </a>
          </div>

          <!-- ✅ Tabs Sticky -->
          <div class="shrink-0 bg-white border-b border-slate-200 px-3 py-2 sticky top-0 z-40">
            <div class="grid grid-cols-2 bg-slate-100 rounded-2xl p-1">
              <button id="btnMobileList" type="button" onclick="showMobilePanel('list')"
                class="h-10 rounded-xl font-extrabold text-slate-800 bg-white shadow-sm">
                List
              </button>
              <button id="btnMobileRincian" type="button" onclick="showMobilePanel('rincian')"
                class="h-10 rounded-xl font-extrabold text-slate-600">
                Rincian
              </button>
            </div>
          </div>

          <!-- ✅ LIST PANEL -->
          <div id="mobilePanelList" class="flex-1 overflow-y-auto pb-28">

            <!-- ✅ Summary -->
            <div class="bg-white border-b border-slate-200">
              <div class="p-3 space-y-2">
                <div class="bg-orange-50 border border-orange-200 rounded-2xl p-3 flex items-center justify-between">
                  <div>
                    <div class="text-[11px] font-bold text-slate-600">Total Pembelian</div>
                    <div class="text-xl font-extrabold text-slate-900" id="displayTotalAmount_m">Rp 0</div>
                  </div>
                  <div class="w-10 h-10 rounded-xl bg-gradient-to-r from-orange-500 to-amber-400 text-white font-extrabold flex items-center justify-center">
                    Rp
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                  <div class="bg-white border border-slate-200 rounded-2xl p-3">
                    <div class="text-[11px] font-bold text-slate-500">Jumlah Transaksi</div>
                    <div class="text-lg font-extrabold text-slate-900" id="displayTotalCount_m">0</div>
                  </div>
                  <div class="bg-white border border-slate-200 rounded-2xl p-3">
                    <div class="text-[11px] font-bold text-slate-500">Total Biaya</div>
                    <div class="text-lg font-extrabold text-slate-900" id="displayTotalFee_m">Rp 0</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ✅ List -->
            <div class="p-3">
              <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                <div class="divide-y divide-slate-200" id="purchasesList">
                  <% allPurchases.concat(branchPurchases).forEach((p) => { %>
                    <div class="purchase-row p-4 cursor-pointer hover:bg-orange-50/50 transition"
                      data-id="<%= p._id %>"
                      data-seller="<%= p.seller %>"
                      data-date="<%= p.createdAt %>"
                      data-amount="<%= p.total || 0 %>"
                      data-fee="<%= p.fee || 0 %>"
                      data-cabang="<%= p.branchCode %>"
                      data-payment="<%= p.PaymentMethod %>"
                      data-order-type="<%= p.orderType %>">

                      <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                          <div class="text-xs text-slate-500 font-semibold">
                            <%= new Date(p.createdAt).toLocaleDateString('id-ID') %> •
                            <%= new Date(p.createdAt).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) %>
                          </div>
                          <div class="text-sm font-extrabold text-slate-900 truncate"><%= p.seller || 'Unknown' %></div>
                          <div class="text-xs text-slate-500 font-semibold"><%= p.branchCode %></div>
                          <div class="text-xs font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-amber-500 mt-1">
                            <%= p.orderType || '-' %>
                          </div>
                        </div>

                        <div class="text-right shrink-0">
                          <div class="text-xs font-bold text-slate-500">
                            <%= p.PaymentMethod || '-' %>
                          </div>
                          <div class="text-base font-extrabold text-slate-900">Rp <%= (p.total || 0).toLocaleString('id-ID') %></div>
                          <div class="text-xs font-extrabold text-orange-600">Biaya: Rp <%= (p.fee || 0).toLocaleString('id-ID') %></div>
                        </div>
                      </div>
                    </div>
                  <% }); %>
                </div>

                <div id="noDataMessage_mobile" class="hidden text-center py-10">
                  <p class="text-slate-700 font-extrabold">Tidak ada data untuk filter ini</p>
                  <p class="text-slate-500 text-sm font-semibold">Coba ubah filter atau periode waktu</p>
                </div>
              </div>
            </div>

          </div>

          <!-- ✅ RINCIAN PANEL -->
          <div id="mobilePanelRincian" class="hidden flex-1 overflow-y-auto bg-white pb-28">
            <div class="p-3 border-b border-slate-200">
              <div class="text-base font-extrabold text-slate-900">Rincian Metode Pembayaran</div>
              <div class="text-xs text-slate-500 font-semibold mt-1">Klik untuk filter metode</div>
            </div>

            <div class="divide-y divide-slate-200">
              <% for (const [key, val] of Object.entries(statsByPayment || {})) { %>
                <div class="source-card px-4 py-3 cursor-pointer hover:bg-orange-50 transition flex items-center justify-between"
                     data-source="<%= key %>"
                     onclick="filterBySource('<%= key %>')">

                  <div class="flex-1">
                    <div class="text-xs font-extrabold uppercase tracking-wider text-slate-700"><%= key %></div>
                    <div class="text-[11px] text-slate-500 font-semibold mt-1">
                      <span class="src-count" data-src="<%= key %>"><%= val.count %></span> Transaksi
                    </div>
                  </div>

                  <div class="text-right">
                    <div class="text-sm font-extrabold text-slate-900">
                      <span class="src-total" data-src="<%= key %>"><%= val.total.toLocaleString('id-ID') %></span>
                    </div>
                  </div>
                </div>
              <% } %>
            </div>
          </div>

        </div>

        <!-- DESKTOP LAYOUT ========================= -->
        <div class="hidden lg:flex h-full">

          <!-- LEFT SIDEBAR -->
          <div class="w-[360px] shrink-0 border-r border-slate-200 bg-white flex flex-col">
            <div class="p-4 border-b border-slate-200 bg-orange-50">
              <h3 class="text-sm font-extrabold text-slate-900">Rincian Metode Pembayaran</h3>
              <p class="text-xs text-slate-600 font-semibold mt-1">Klik untuk filter metode</p>
            </div>

            <div class="flex-1 overflow-y-auto">
              <% for (const [key, val] of Object.entries(statsByPayment || {})) { %>
                <div class="source-card border-b border-slate-100 px-4 py-3 cursor-pointer hover:bg-orange-50 transition flex items-center justify-between"
                     data-source="<%= key %>"
                     onclick="filterBySource('<%= key %>')">

                  <div class="flex-1">
                    <div class="text-xs font-extrabold uppercase tracking-wider text-slate-700"><%= key %></div>
                    <div class="text-[11px] text-slate-500 font-semibold mt-1">
                      <span class="src-count" data-src="<%= key %>"><%= val.count %></span> Transaksi
                    </div>
                  </div>

                  <div class="text-right">
                    <div class="text-sm font-extrabold text-slate-900">
                      <span class="src-total" data-src="<%= key %>"><%= val.total.toLocaleString('id-ID') %></span>
                    </div>
                  </div>
                </div>
              <% } %>
            </div>
          </div>

          <!-- RIGHT CONTENT -->
          <div class="flex-1 min-w-0 flex flex-col bg-background">
            <div class="p-4 border-b border-slate-200 bg-white">
              <div class="grid grid-cols-3 gap-3">
                <div class="bg-orange-50 border border-orange-200 rounded-2xl p-4 flex items-center justify-between">
                  <div>
                    <div class="text-xs font-bold text-slate-600">Total Pembelian</div>
                    <div class="text-xl font-extrabold text-slate-900" id="displayTotalAmount">Rp 0</div>
                  </div>
                  <div class="w-10 h-10 rounded-xl bg-gradient-to-r from-orange-500 to-amber-400 text-white font-extrabold flex items-center justify-center">Rp</div>
                </div>

                <div class="bg-white border border-slate-200 rounded-2xl p-4">
                  <div class="text-xs font-bold text-slate-500">Total Transaksi</div>
                  <div class="text-xl font-extrabold text-slate-900" id="displayTotalCount">0</div>
                </div>

                <div class="bg-white border border-slate-200 rounded-2xl p-4">
                  <div class="text-xs font-bold text-slate-500">Total Biaya</div>
                  <div class="text-xl font-extrabold text-slate-900" id="displayTotalFee">Rp 0</div>
                </div>
              </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
              <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto touch-scroll">
                  <table class="w-full text-left">
                    <thead class="bg-orange-50 border-b border-orange-200">
                      <tr>
                        <th class="px-6 py-4 text-xs font-extrabold text-slate-600 uppercase tracking-wider">Penjual</th>
                        <th class="px-6 py-4 text-xs font-extrabold text-slate-600 uppercase tracking-wider">Cabang</th>
                        <th class="px-6 py-4 text-xs font-extrabold text-slate-600 uppercase tracking-wider text-right">Total</th>
                        <th class="px-6 py-4 text-xs font-extrabold text-slate-600 uppercase tracking-wider text-right">Biaya</th>
                      </tr>
                    </thead>

                    <tbody class="divide-y divide-slate-100" id="purchaseTableBody">
                      <% allPurchases.concat(branchPurchases).forEach((p) => { %>
                      <tr class="purchase-row hover:bg-orange-50/50 transition cursor-pointer"
                          data-id="<%= p._id %>"
                          data-seller="<%= p.seller %>"
                          data-date="<%= p.createdAt %>"
                          data-amount="<%= p.total || 0 %>"
                          data-fee="<%= p.fee || 0 %>"
                          data-cabang="<%= p.branchCode %>"
                          data-payment="<%= p.PaymentMethod %>"
                          data-order-type="<%= p.orderType %>">

                        <td class="px-6 py-4 whitespace-nowrap">
                          <div class="flex flex-col">
                            <span class="text-[11px] text-slate-500 font-semibold">
                              <%= new Date(p.createdAt).toLocaleDateString('id-ID') %> •
                              <%= new Date(p.createdAt).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) %>
                            </span>
                            <span class="text-sm font-extrabold text-slate-900"><%= p.seller || 'Unknown' %></span>
                            <span class="text-xs font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-amber-500">
                              <%= p.orderType || '-' %>
                            </span>
                          </div>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap">
                          <span class="text-sm font-bold text-slate-900"><%= p.branchCode %></span>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-right">
                          <div class="inline-flex flex-col items-end px-3 py-2 rounded-2xl border border-slate-200 bg-slate-50">
                            <span class="text-[11px] font-bold text-slate-500"><%= p.PaymentMethod || '-' %></span>
                            <span class="text-base font-extrabold text-slate-900">Rp <%= (p.total || 0).toLocaleString('id-ID') %></span>
                          </div>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-right">
                          <div class="inline-flex flex-col items-end px-3 py-2 rounded-2xl border border-slate-200 bg-slate-50">
                            <span class="text-[11px] font-bold text-slate-500">BIAYA</span>
                            <span class="text-sm font-extrabold text-orange-600">Rp <%= (p.fee || 0).toLocaleString('id-ID') %></span>
                          </div>
                        </td>
                      </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>

                <div id="noDataMessage" class="hidden text-center py-12">
                  <p class="text-slate-700 font-extrabold">Tidak ada data untuk filter ini</p>
                  <p class="text-slate-500 text-sm font-semibold">Coba ubah filter atau periode waktu</p>
                </div>

              </div>
            </div>
          </div>

        </div>

      </div>

    </div>
  </div>

<script>
  // ✅ Mobile list/rincian toggle
  function showMobilePanel(which) {
    const list = document.getElementById('mobilePanelList');
    const rin = document.getElementById('mobilePanelRincian');

    const bList = document.getElementById('btnMobileList');
    const bRin  = document.getElementById('btnMobileRincian');

    if (which === 'rincian') {
      list.classList.add('hidden');
      rin.classList.remove('hidden');

      bList.classList.remove('bg-white','shadow-sm','text-slate-800');
      bList.classList.add('text-slate-600');

      bRin.classList.add('bg-white','shadow-sm','text-slate-800');
      bRin.classList.remove('text-slate-600');
    } else {
      rin.classList.add('hidden');
      list.classList.remove('hidden');

      bRin.classList.remove('bg-white','shadow-sm','text-slate-800');
      bRin.classList.add('text-slate-600');

      bList.classList.add('bg-white','shadow-sm','text-slate-800');
      bList.classList.remove('text-slate-600');
    }
  }

  let activeSourceFilter = null;

  window.onload = function() {
    const today = new Date().toISOString().split('T')[0];

    const dr = document.getElementById('dateRangeFilter');
    if (dr) dr.value = 'today';

    const s = document.getElementById('startDate');
    const e = document.getElementById('endDate');
    if (s) s.value = today;
    if (e) e.value = today;

    const customInputs = document.getElementById('customDateInputs');
    if (customInputs) { customInputs.classList.add('hidden'); customInputs.classList.remove('flex'); }

    showMobilePanel('list');
    applyFilters();
  };

  function handleDateSelect() {
    const select = document.getElementById('dateRangeFilter');
    const customInputs = document.getElementById('customDateInputs');
    if (!select || !customInputs) return;

    if (select.value === 'custom') {
      customInputs.classList.remove('hidden');
      customInputs.classList.add('flex');
    } else {
      customInputs.classList.add('hidden');
      customInputs.classList.remove('flex');
      applyFilters();
    }
  }

  function resetFilters() {
    const today = new Date().toISOString().split('T')[0];

    activeSourceFilter = null;
    document.querySelectorAll('.source-card').forEach(card => card.classList.remove('active'));

    const b = document.getElementById('branchFilter');
    if (b) b.value = 'all';

    const dr = document.getElementById('dateRangeFilter');
    if (dr) dr.value = 'today';

    const s = document.getElementById('startDate');
    const e = document.getElementById('endDate');
    if (s) s.value = today;
    if (e) e.value = today;

    const customInputs = document.getElementById('customDateInputs');
    if (customInputs) { customInputs.classList.add('hidden'); customInputs.classList.remove('flex'); }

    applyFilters();
  }

  function applyFilters() {
    const dateFilter = document.getElementById('dateRangeFilter')?.value || 'today';
    const branchSelect = document.getElementById('branchFilter');
    const branchFilter = branchSelect ? branchSelect.value : 'all';

    const startDateVal = document.getElementById('startDate')?.value;
    const endDateVal = document.getElementById('endDate')?.value;

    const rows = document.querySelectorAll('.purchase-row');

    let visibleCount = 0;
    let visibleAmount = 0;
    let visibleFee = 0;

    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    rows.forEach(row => {
      const rowDateStr = row.getAttribute('data-date');
      const rowCabang = row.getAttribute('data-cabang');
      const rowAmount = parseFloat(row.getAttribute('data-amount') || '0');
      const rowFee = parseFloat(row.getAttribute('data-fee') || '0');
      const rowDate = new Date(rowDateStr);

      let dateMatch = false;

      if (dateFilter === 'all') dateMatch = true;
      else if (dateFilter === 'today') dateMatch = rowDate >= todayStart;
      else if (dateFilter === 'custom') {
        if (startDateVal && endDateVal) {
          const start = new Date(startDateVal);
          const end = new Date(endDateVal);
          end.setHours(23, 59, 59);
          dateMatch = rowDate >= start && rowDate <= end;
        } else dateMatch = true;
      } else {
        const daysAgo = parseInt(dateFilter);
        const cutoffDate = new Date(now);
        cutoffDate.setDate(now.getDate() - daysAgo);
        dateMatch = rowDate >= cutoffDate;
      }

      const branchMatch = (branchFilter === 'all') ? true : (rowCabang === branchFilter);

      const rowPayment = (row.getAttribute('data-payment') || '').trim();

      let paymentMatch = true;
      if (activeSourceFilter) {
        paymentMatch = rowPayment === activeSourceFilter;
      }

      if (dateMatch && branchMatch && paymentMatch) {
        row.style.display = '';
        visibleCount++;
        visibleAmount += rowAmount;
        visibleFee += rowFee;
      } else {
        row.style.display = 'none';
      }
    });

    const noDataMsg = document.getElementById('noDataMessage');
    const noDataMsgM = document.getElementById('noDataMessage_mobile');

    if (visibleCount === 0) {
      noDataMsg?.classList.remove('hidden');
      noDataMsgM?.classList.remove('hidden');
    } else {
      noDataMsg?.classList.add('hidden');
      noDataMsgM?.classList.add('hidden');
    }

    updateStats(visibleAmount, visibleCount, visibleFee);
    updateSourceCardsFromVisibleRows();
  }

  function updateStats(amount, count, fee) {
    const a = document.getElementById("displayTotalAmount");
    const c = document.getElementById("displayTotalCount");
    const f = document.getElementById("displayTotalFee");
    if (a) a.innerText = 'Rp ' + amount.toLocaleString('id-ID');
    if (c) c.innerText = count;
    if (f) f.innerText = 'Rp ' + fee.toLocaleString('id-ID');

    const am = document.getElementById("displayTotalAmount_m");
    const cm = document.getElementById("displayTotalCount_m");
    const fm = document.getElementById("displayTotalFee_m");
    if (am) am.innerText = 'Rp ' + amount.toLocaleString('id-ID');
    if (cm) cm.innerText = count;
    if (fm) fm.innerText = 'Rp ' + fee.toLocaleString('id-ID');
  }

  function updateSourceCardsFromVisibleRows() {
    const rows = document.querySelectorAll('.purchase-row');
    const agg = {};

    rows.forEach(row => {
      if (row.style.display === 'none') return;

      const payment = (row.getAttribute('data-payment') || '').trim();
      const amount = parseFloat(row.getAttribute('data-amount') || '0');

      const key = payment || 'Unknown';
      if (!agg[key]) agg[key] = { count: 0, total: 0 };

      agg[key].count += 1;
      agg[key].total += amount;
    });

    document.querySelectorAll('.src-count').forEach(el => {
      const key = el.getAttribute('data-src');
      el.textContent = (agg[key]?.count || 0);
    });

    document.querySelectorAll('.src-total').forEach(el => {
      const key = el.getAttribute('data-src');
      el.textContent = (agg[key]?.total || 0).toLocaleString('id-ID');
    });
  }

  function filterBySource(source) {
    activeSourceFilter = (activeSourceFilter === source) ? null : source;

    document.querySelectorAll('.source-card').forEach(card => {
      if (card.getAttribute('data-source') === activeSourceFilter) card.classList.add('active');
      else card.classList.remove('active');
    });

    applyFilters();
  }
</script>

<!-- Service Worker Registration -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js').then(reg => {
        console.log('✅ Service Worker registered:', reg);
      }).catch(err => {
        console.error('❌ Service Worker registration failed:', err);
      });
    });
  }
</script>

</body>
</html>
