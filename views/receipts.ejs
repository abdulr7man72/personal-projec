<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة الفواتير - receipts_ocr</title>
  <!-- Tailwind CDN للتصميم السريع -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 text-slate-800">

  <div class="max-w-6xl mx-auto p-4">

    <!-- العنوان -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold mb-1">لوحة الفواتير (receipts_ocr)</h1>
      <p class="text-sm text-slate-500">عرض جميع الفواتير المخزّنة مع الإحصائيات.</p>
    </div>

    <!-- كروت الإحصائيات الأساسية -->
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow p-4">
        <p class="text-xs text-slate-500 mb-1">عدد الفواتير</p>
        <p class="text-2xl font-bold"><%= stats.totalInvoices %></p>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <p class="text-xs text-slate-500 mb-1">مجموع الإجمالي (grand_total)</p>
        <p class="text-xl font-semibold">
          Rp <%= stats.totalGrand.toLocaleString("id-ID") %>
        </p>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <p class="text-xs text-slate-500 mb-1">مجموع الخصم</p>
        <p class="text-xl font-semibold">
          Rp <%= stats.totalDiscount.toLocaleString("id-ID") %>
        </p>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <p class="text-xs text-slate-500 mb-1">مجموع المدفوع</p>
        <p class="text-xl font-semibold">
          Rp <%= stats.totalPaid.toLocaleString("id-ID") %>
        </p>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <p class="text-xs text-slate-500 mb-1">مجموع الباقي (change)</p>
        <p class="text-xl font-semibold">
          Rp <%= stats.totalChange.toLocaleString("id-ID") %>
        </p>
      </div>
    </div>

    <!-- إحصائيات حسب طريقة الدفع -->
    <div class="mb-6 bg-white rounded-xl shadow p-4">
      <h2 class="text-lg font-semibold mb-3">الإحصائيات حسب طريقة الدفع</h2>
      <table class="w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
        <thead class="bg-slate-50">
          <tr>
            <th class="border px-3 py-2 text-right">طريقة الدفع</th>
            <th class="border px-3 py-2 text-right">عدد الفواتير</th>
            <th class="border px-3 py-2 text-right">مجموع الإجمالي</th>
          </tr>
        </thead>
        <tbody>
          <% Object.keys(stats.byPayment).forEach(function(method) { 
               const row = stats.byPayment[method]; %>
            <tr>
              <td class="border px-3 py-1"><%= method %></td>
              <td class="border px-3 py-1"><%= row.count %></td>
              <td class="border px-3 py-1">
                Rp <%= row.total.toLocaleString("id-ID") %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- جدول الفواتير -->
    <div class="bg-white rounded-xl shadow p-4">
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-3">
  <div>
    <h2 class="text-lg font-semibold">جميع الفواتير</h2>
    <p class="text-xs text-slate-500">
      يظهر آخر <%= receipts.length %> فاتورة (مرتبة من الأحدث للأقدم)
    </p>
  </div>

  <a
    href="/receipts/export"
    class="inline-flex items-center justify-center px-3 py-2 rounded-lg text-xs md:text-sm font-medium bg-emerald-600 text-white hover:bg-emerald-700 transition"
  >
    ⬇️ تحميل بصيغة CSV (Google Sheets)
  </a>
</div>


      <div class="overflow-x-auto">
        <table class="min-w-full text-xs md:text-sm border border-slate-200 rounded-lg overflow-hidden">
          <thead class="bg-slate-50">
            <tr>
              <th class="border px-2 py-2">#</th>
              <th class="border px-2 py-2 text-right">التاريخ</th>
              <th class="border px-2 py-2 text-right">البائع</th>
              <th class="border px-2 py-2 text-right">الإجمالي</th>
              <th class="border px-2 py-2 text-right">الخصم</th>
              <th class="border px-2 py-2 text-right">طريقة الدفع</th>
              <th class="border px-2 py-2 text-right">المدفوع</th>
              <th class="border px-2 py-2 text-right">الباقي</th>
              <th class="border px-2 py-2 text-right">الأصناف</th>
             <th class="border px-2 py-2 text-center">إجراءات</th>

            </tr>
          </thead>
          <tbody>
            <% receipts.forEach(function(r, index) { %>
              <tr class="hover:bg-slate-50">
                <td class="border px-2 py-1 text-center"><%= index + 1 %></td>
                <td class="border px-2 py-1">
                  <% if (r.date) { %>
                    <%= r.date.toLocaleString("id-ID") %>
                  <% } else { %>
                    <%= r.date_raw || "-" %>
                  <% } %>
                </td>
                <td class="border px-2 py-1"><%= r.seller || "-" %></td>
                <td class="border px-2 py-1">
                  Rp <%= (Number(r.grand_total)||0).toLocaleString("id-ID") %>
                </td>
                <td class="border px-2 py-1">
                  Rp <%= (Number(r.discount_total)||0).toLocaleString("id-ID") %>
                </td>
                <td class="border px-2 py-1"><%= r.payment_method || "-" %></td>
                <td class="border px-2 py-1">
                  Rp <%= (Number(r.amount_paid)||0).toLocaleString("id-ID") %>
                </td>
                <td class="border px-2 py-1">
                  Rp <%= (Number(r.change_amount)||0).toLocaleString("id-ID") %>
                </td>
<td class="border px-2 py-1 text-right text-xs md:text-sm leading-relaxed">
  <% if (r.items && r.items.length) { %>
    <% r.items.forEach(function(it, i) { %>
      <div class="py-1 border-b last:border-b-0 border-slate-200">
        <strong><%= i + 1 %>) <%= it.name || "-" %></strong><br>
        الكمية: <%= it.quantity || 0 %><br>
        السعر: Rp <%= (Number(it.price) || 0).toLocaleString("id-ID") %>
      </div>
    <% }) %>
  <% } else { %>
    لا يوجد أصناف
  <% } %>
</td>
<td class="border px-2 py-1 text-center">
  <div class="flex gap-2 justify-center">
    <!-- زر تعديل -->
    <a
      href="/receipts/<%= r._id %>/edit"
      class="px-2 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700"
    >
      تعديل
    </a>

    <!-- زر حذف -->
    <form action="/receipts/<%= r._id %>/delete" method="POST" onsubmit="return confirm('هل أنت متأكد من الحذف؟');">
      <button
        type="submit"
        class="px-2 py-1 text-xs rounded bg-red-600 text-white hover:bg-red-700"
      >
        حذف
      </button>
    </form>
  </div>
</td>


              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</body>
</html>
